Default shell is PowerShell; keep commands compatible. Avoid generating docs unless asked. Favor small, composable functions and leave room for future integrations.

# Rakuten Telegram Credential Checker — AI Agent Playbook

- **Architecture**: [main.js](../main.js) loads env, ensures `screenshots/`, and wires Telegraf via `initializeTelegramHandler`. [telegramHandler.js](../telegramHandler.js) owns Telegram UX, input guards, credential checks, batch flows, and capture follow-ups. [puppeteerChecker.js](../puppeteerChecker.js) orchestrates automation via [automation/browserManager.js](../automation/browserManager.js), [automation/rakutenFlow.js](../automation/rakutenFlow.js), and [automation/resultAnalyzer.js](../automation/resultAnalyzer.js).
- **Env**: Required `TELEGRAM_BOT_TOKEN`, `TARGET_LOGIN_URL`. Optional `TIMEOUT_MS` (default 60000), `SCREENSHOT_ON` (only captures when true), `PROXY_SERVER`, `HEADLESS` (supports `'new'`, true/false). Defaults set in [main.js](../main.js) and [puppeteerChecker.js](../puppeteerChecker.js).
- **Single credential flow**: `.chk email:password` → guard/parse → `checkCredentials` → Rakuten two-step → `/v2/login/complete` analysis → formatted status edit. Valid results keep the session open for optional capture; expired/declined closes the session. Screenshots are not sent and are deleted; only taken if `SCREENSHOT_ON=true`.
- **Capture follow-up**: After VALID, bot prompts “Proceed to capture data?”; accept runs [automation/dataCapture.js](../automation/dataCapture.js) to scrape points/cash on `https://my.rakuten.co.jp/...`. Decline or expiry closes the preserved session. Credentials in summaries use spoiler + monospace.
- **Batch uploads (document)**: On file upload, bot asks type: HOTMAIL (<=50MB, Microsoft .jp domains only) or ULP (stream up to ~1.5GB). HOTMAIL parsing uses [automation/batchProcessor.js](../automation/batchProcessor.js) with `ALLOWED_DOMAINS`. ULP parsing streams lines containing `rakuten.co.jp`, extracts `user:pass`, dedupes. Confirmation adds Proceed/Cancel; an Abort button is shown during execution. Batch execution runs concurrently (`BATCH_CONCURRENCY`=3) with progress edits and final summary listing VALID creds (spoiler+monospace) and elapsed time.
- **Inline callbacks**: Capture (`capture_data`/`capture_decline`), batch confirm/cancel/abort (`batch_confirm_*`, `batch_cancel_*`, `batch_abort_*`), type selectors (`batch_type_hotmail_*`, `batch_type_ulp_*`). Replies should thread to the originating message via `reply_to_message_id` when possible.
- **Puppeteer specifics**: Launch options include `--no-sandbox`, `--disable-setuid-sandbox`, `--disable-dev-shm-usage`, `--disable-gpu`, random UA via `user-agents`, incognito context, viewport 1920x1080. Proxy via `--proxy-server=` if set. Navigation uses `networkidle0`; waits respect `timeoutMs`; password submit waits 2s post-response.
- **Outcome detection**: [resultAnalyzer.js](../automation/resultAnalyzer.js) prioritizes 200 with `code=` redirect → VALID; 401 JSON → INVALID; captcha/ challenge → BLOCKED; invalid text → INVALID; URL `code=` fallback → VALID; else ERROR.
- **Error handling & cleanup**: `checkCredentials` uses try/finally and closes browsers unless `deferCloseOnValid` holds the session for capture. Batch executor catches per-credential errors and totals ERRORs instead of throwing. Abort sets `batch.aborted` to stop workers and report as aborted with timing.
- **Commands**: `npm install`; `npm start` (or `npm run dev`). No tests. For Windows service see [DEPLOYMENT.md](../DEPLOYMENT.md).
- **Patterns to follow**: Use MarkdownV2 escaping (`escapeV2`) for user content; prefer editing existing status messages over new messages; keep inline keyboards simple and clear; delete temporary screenshots; preserve privacy by masking/spoiler for credentials.

If anything is unclear or missing (e.g., capture targets, selector changes, batch parsing rules), ask which part to expand.
