Default shell is PowerShell, keep commands compatible.
Avoid generating documentation unless asked. Favor small, composable functions and keep room for future integrations.

# Rakuten Telegram Credential Checker — AI Agent Playbook

- **Architecture & flow**: [main.js](main.js) bootstraps env vars, ensures screenshots dir, and wires Telegraf handler. [telegramHandler.js](telegramHandler.js) listens for `.chk email:password`, guards input, edits status messages, and posts results/screenshots. [puppeteerChecker.js](puppeteerChecker.js) orchestrates the automation by delegating to [automation/browserManager.js](automation/browserManager.js), [automation/rakutenFlow.js](automation/rakutenFlow.js), and [automation/resultAnalyzer.js](automation/resultAnalyzer.js).
- **Data path**: Telegram command → `guardInput`/`parseCredentials` → `checkCredentials(email, password, options)` → Puppeteer launch + Rakuten two-step flow → `/v2/login/complete` response analysis → formatted Telegram message (+ optional screenshot).
- **Env & options**: Required `TELEGRAM_BOT_TOKEN`, `TARGET_LOGIN_URL`. Optional `TIMEOUT_MS` (default 60000), `SCREENSHOT_ON` (`true` enables always-on capture), `PROXY_SERVER`. Options propagate from main → telegram handler → puppeteer checker; defaults live in [main.js](main.js) and [puppeteerChecker.js](puppeteerChecker.js).
- **Input guards** (Telegram): enforced in [telegramHandler.js](telegramHandler.js#L20-L99): max 200 chars, must include `@` and `:`, exactly one colon, email regex, password 4–100 chars, no spaces. Validation errors return immediately; credentials are masked in responses.
- **Telegram UX**: Uses Telegraf (not node-telegram-bot-api). Commands: `/start`, `/help`, `.chk ...`. Status uses Markdown + emojis; edits the initial message; sends screenshots via `replyWithPhoto`; inline buttons for VALID (`save_valid`, `copy_account`, `check_another`).
- **Puppeteer launch**: `headless: 'new'`, args include `--no-sandbox`, `--disable-setuid-sandbox`, `--disable-dev-shm-usage`, `--disable-gpu`; random User-Agent via `user-agents`; incognito context per run; viewport 1920x1080. Add proxy with `--proxy-server=` in [browserManager.js](automation/browserManager.js#L5-L43).
- **Rakuten flow**: [rakutenFlow.js](automation/rakutenFlow.js#L1-L108) navigates to `targetUrl`, fills email (email selector list), clicks advance, waits for password screen, fills password, and awaits `/v2/login/complete` response. Advance button search tries submit buttons first, then text match (`next`, `sign in`, `ログイン`, etc.).
- **Outcome detection**: [resultAnalyzer.js](automation/resultAnalyzer.js#L1-L76) priority: (1) `response.status === 200` and redirect URL contains `www.rakuten.co.jp` + `code=` → VALID; (2) `response.status === 401` with JSON `errorCode/message` → INVALID; (3) page content captcha/challenge keywords → BLOCKED; (4) error text like `incorrect/invalid/wrong password` → INVALID; (5) URL fallback with `code=` → VALID; else ERROR with current URL.
- **Screenshots**: [resultAnalyzer.js](automation/resultAnalyzer.js#L78-L109) saves to `screenshots/{STATUS}-{timestamp}.png` (created recursively). Taken automatically on non-VALID or when `screenshotOn` is true; path attached to result.
- **Error handling & cleanup**: `checkCredentials` wraps automation in try/finally and always calls `closeBrowserSession`; on errors returns `{ status: 'ERROR', message: 'Automation error: ...', screenshot? }`. Browser close is guarded with `catch(() => {})`.
- **Defaults & timeouts**: Navigation waits use `networkidle0` on initial load; email/password waits respect `timeoutMs`; password submission waits 2s after request to allow redirects.
- **Commands to run**: `npm install`; `npm start` (or `npm run dev`). No tests present. For Windows service see [DEPLOYMENT.md](DEPLOYMENT.md).
- **Common tweaks**: To view browser, adjust `headless` in [browserManager.js](automation/browserManager.js). To change selectors or flow markers, update [rakutenFlow.js](automation/rakutenFlow.js) and [resultAnalyzer.js](automation/resultAnalyzer.js) in tandem.

If anything is unclear or missing for your task, ask which part to expand (e.g., deployment, selector changes, or Telegram UX).
