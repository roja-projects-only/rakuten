Default shell is PowerShell; keep commands compatible. Avoid generating docs unless asked. Favor small, composable functions.

# Rakuten Telegram Credential Checker — AI Agent Playbook

- **Architecture**: [main.js](../main.js) loads env, ensures `screenshots/`, boots Telegraf via `initializeTelegramHandler`. [telegramHandler.js](../telegramHandler.js) runs `.chk` UX, capture prompts, batch UX in [telegram/batchHandlers.js](../telegram/batchHandlers.js). Checker is switchable via `USE_HTTP_CHECKER`: 
	- Puppeteer path: [puppeteerChecker.js](../puppeteerChecker.js) → [automation/browserManager.js](../automation/browserManager.js) (shared Chromium with recycle) → [automation/rakutenFlow.js](../automation/rakutenFlow.js) (form steps) → [automation/resultAnalyzer.js](../automation/resultAnalyzer.js) (outcome) → [automation/dataCapture.js](../automation/dataCapture.js).
	- HTTP path: [httpChecker.js](../httpChecker.js) → [automation/http/httpFlow.js](../automation/http/httpFlow.js) (login via HTTP), [automation/http/htmlAnalyzer.js](../automation/http/htmlAnalyzer.js) (outcome), [automation/http/httpDataCapture.js](../automation/http/httpDataCapture.js) (HTML scrape), fingerprinting in [automation/http/fingerprinting](../automation/http/fingerprinting) (placeholders—needs real payloads from DevTools).
- **Env**: Required `TELEGRAM_BOT_TOKEN`, `TARGET_LOGIN_URL`. Optional `TIMEOUT_MS` (default 60000), `SCREENSHOT_ON`, `PROXY_SERVER`, `HEADLESS`, `LOG_LEVEL`. Browser recycle knobs: `BROWSER_MAX_AGE_MS`, `BROWSER_MAX_IDLE_MS`, `BROWSER_MAX_USES`. HTTP switch `USE_HTTP_CHECKER=true|false` (default false) and batch knob `BATCH_CONCURRENCY` (default 8, higher ok for HTTP once payloads are real).
- **Single credential flow**: `.chk email:password` → `guardInput`/`parseCredentials` → `checkCredentials` (HTTP or Puppeteer) → `detectOutcome` → status edit. VALID keeps session for capture; INVALID/BLOCKED/ERROR closes session. HTTP flow currently uses placeholder payloads for `/v2/login/start` and `/v2/login/complete`—replace with real DevTools captures before relying on it.
- **Capture flow**: On VALID, inline buttons. `capture_data` uses Puppeteer [dataCapture.js](../automation/dataCapture.js); HTTP mode uses [automation/http/httpDataCapture.js](../automation/http/httpDataCapture.js). Spoiler + monospace for creds in summaries; delete screenshots after send.
- **Batch handling**: HOTMAIL uploads (<=20MB API limit, parser enforces .jp Microsoft) and ULP URLs (stream up to ~1.5GB). Deduping in [automation/batchProcessor.js](../automation/batchProcessor.js) with processed cache ([automation/batch/processedStore.js](../automation/batch/processedStore.js)). Progress edits throttled ~5s; abort via callbacks.
- **Logging**: Use `createLogger(scope)` from [logger.js](../logger.js); levels error|warn|info|debug|trace (set via `LOG_LEVEL`). Avoid raw `console`.
- **Puppeteer specifics**: Launch args `--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-gpu`; viewport 1920x1080; random UA; incognito per check; `networkidle0` waits; ~2s delay after password submit; proxy via launch arg.
- **HTTP specifics**: Axios client with cookie jar in [httpClient.js](../automation/http/httpClient.js); session recycling in [sessionManager.js](../automation/http/sessionManager.js). Fingerprinting modules are stubs—wire real RAT/challenge/bio payloads from Chrome DevTools before production. Redirect following handled in `followRedirects`.
- **Outcome detection**: [resultAnalyzer.js](../automation/resultAnalyzer.js) and [htmlAnalyzer.js](../automation/http/htmlAnalyzer.js): 200+redirect code→VALID, URL `code=` fallback→VALID, 401 JSON→INVALID, captcha/challenge keywords→BLOCKED, invalid keywords→INVALID else ERROR.
- **Markdown/Telegram**: Escape user text with `escapeV2`; wrap file/url strings via `codeSpan`; batch progress/summary use MarkdownV2; credentials in summaries use spoilers + monospace; always thread replies when `reply_to_message_id` exists.
- **Commands/build**: `npm install`; `npm start` (no tests). Windows service guidance in [DEPLOYMENT.md](../DEPLOYMENT.md). For HTTP mode debugging, see [HTTP_TESTING.md](../HTTP_TESTING.md) and capture real request bodies/headers before expecting success.

If anything is unclear (capture selectors, batch parsing edge cases, HTTP payloads), ask to expand that section.
