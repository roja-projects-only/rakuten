Default shell is PowerShell; keep commands compatible. Avoid generating docs unless asked. Favor small, composable functions.

# Rakuten Telegram Credential Checker — AI Agent Playbook

- **Architecture**: [main.js](../main.js) loads env, ensures `screenshots/`, and boots Telegraf via `initializeTelegramHandler`. [telegramHandler.js](../telegramHandler.js) runs `.chk` UX, capture prompts, and wires batch UX to [telegram/batchHandlers.js](../telegram/batchHandlers.js). Checks go through [puppeteerChecker.js](../puppeteerChecker.js) which uses [automation/browserManager.js](../automation/browserManager.js) (shared browser with recycle), [automation/rakutenFlow.js](../automation/rakutenFlow.js) (form flow), and [automation/resultAnalyzer.js](../automation/resultAnalyzer.js) (outcome detect). Data capture is in [automation/dataCapture.js](../automation/dataCapture.js).
- **Logging**: Use `createLogger(scope)` from [logger.js](../logger.js). Set `LOG_LEVEL` (error|warn|info|debug|trace). Avoid raw `console` in new code.
- **Env**: Required `TELEGRAM_BOT_TOKEN`, `TARGET_LOGIN_URL`. Optional `TIMEOUT_MS` (default 60000), `SCREENSHOT_ON` (`true` to attach), `PROXY_SERVER`, `HEADLESS` (`'new'`/true/false), `LOG_LEVEL`. Browser recycle knobs: `BROWSER_MAX_AGE_MS`, `BROWSER_MAX_IDLE_MS`, `BROWSER_MAX_USES` (defaults: 10m age, 5m idle, 50 uses).
- **Single credential flow**: `.chk email:password` → `guardInput` + `parseCredentials` → `checkCredentials` (navigate, email submit, password submit, wait `/v2/login/complete`) → `detectOutcome` → status edit. VALID keeps session for capture; INVALID/BLOCKED/ERROR closes session. Screenshots deleted after send when captured.
- **Capture follow-up**: On VALID, inline buttons. `capture_data` calls [dataCapture.js](../automation/dataCapture.js) to scrape points/cash and replies with MarkdownV2 spoilers of creds. Decline/timeout closes session.
- **Batch handling**: Docs are HOTMAIL-only (<=50MB); ULP via `.ulp <url>` streams up to ~1.5GB. Workers concurrency 3, progress edits throttled ~5s. HOTMAIL parser ([automation/batch/hotmail.js](../automation/batch/hotmail.js)) enforces `ALLOWED_DOMAINS` (.jp Microsoft) and dedupes `user:pass`. ULP parser ([automation/batch/ulp.js](../automation/batch/ulp.js)) keeps lines with `rakuten.co.jp`, accepts `user:pass` or `url:user:pass` (allowPrefix), dedupes, rejects HTML download pages. Redirects followed with desktop UA via [automation/batch/http.js](../automation/batch/http.js).
- **Inline callbacks**: Capture (`capture_data`/`capture_decline`); batch confirm/cancel/abort (`batch_confirm_*`, `batch_cancel_*`, `batch_abort_*`); HOTMAIL selector (`batch_type_hotmail_*`). Thread replies with `reply_to_message_id` when available.
- **Puppeteer**: Launch args include `--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-gpu`; random UA; viewport 1920x1080; incognito context per check; proxy via `--proxy-server=`. Navigation waits currently `networkidle0`; password submit waits ~2s after response; screenshots via result analyzer when enabled.
- **Outcome detection**: [resultAnalyzer.js](../automation/resultAnalyzer.js) rules: 200 + redirect URL `code=` → VALID; URL `code=` fallback → VALID; 401 JSON → INVALID; captcha/challenge keywords → BLOCKED; invalid-text keywords → INVALID; else ERROR.
- **Markdown patterns**: Escape user text with `escapeV2`; file/url strings in `codeSpan`; batch progress/summary use MarkdownV2; credentials in summaries use spoilers + monospace.
- **Cleanup**: `checkCredentials` closes browsers unless `deferCloseOnValid` (capture path); batch executor tallies per-status; abort flag halts workers; screenshots removed after send.
- **Commands/build**: `npm install`; `npm start` (no tests). Windows service guidance in [DEPLOYMENT.md](../DEPLOYMENT.md).

If anything is unclear (capture selectors, batch parsing edge cases, recycle knobs), ask to expand that section.
