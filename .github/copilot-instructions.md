Default shell is PowerShell; keep commands compatible. Avoid generating docs unless asked. Favor small, composable functions and leave room for future integrations.

# Rakuten Telegram Credential Checker — AI Agent Playbook

- **Architecture**: [main.js](../main.js) boots env + `screenshots/`, then wires Telegraf via `initializeTelegramHandler`. [telegramHandler.js](../telegramHandler.js) owns Telegram UX, `.chk` flow, capture prompts, and delegates batch UX to [telegram/batchHandlers.js](../telegram/batchHandlers.js). Checks run through [puppeteerChecker.js](../puppeteerChecker.js) which composes [automation/browserManager.js](../automation/browserManager.js), [automation/rakutenFlow.js](../automation/rakutenFlow.js), and [automation/resultAnalyzer.js](../automation/resultAnalyzer.js). Data capture lives in [automation/dataCapture.js](../automation/dataCapture.js).
- **Env**: Required `TELEGRAM_BOT_TOKEN`, `TARGET_LOGIN_URL`. Optional `TIMEOUT_MS` (default 60000), `SCREENSHOT_ON` (capture only when true), `PROXY_SERVER`, `HEADLESS` (`'new'`/true/false). Defaults set in main/puppeteerChecker.
- **Single credential flow**: `.chk email:password` → `guardInput` + `parseCredentials` → `checkCredentials` (email/password submit, wait for `/v2/login/complete`) → `detectOutcome` → formatted status edit. VALID keeps session open for capture; INVALID/BLOCKED/ERROR closes session. Screenshots are deleted after send (only when `SCREENSHOT_ON=true`).
- **Capture follow-up**: On VALID, prompt for capture; `capture_data` runs [dataCapture.js](../automation/dataCapture.js) scraping points/cash at `https://my.rakuten.co.jp/...` and replies with spoiler-wrapped creds. Decline or timeout closes session.
- **Batch handling**: Document uploads are HOTMAIL-only (<=50MB Telegram limit); ULP must use `.ulp <url>` (streams up to ~1.5GB). Batch workers live in [telegram/batchHandlers.js](../telegram/batchHandlers.js) with concurrency 3 and progress edits throttled to ~5s. HOTMAIL parser ([automation/batch/hotmail.js](../automation/batch/hotmail.js)) enforces `ALLOWED_DOMAINS` (.jp Microsoft) and dedupes by `user:pass`. ULP parser ([automation/batch/ulp.js](../automation/batch/ulp.js)) streams lines containing `rakuten.co.jp`, accepts `user:pass` and `url:user:pass` via `allowPrefix`, dedupes, and requires direct download URLs (HTML responses are rejected). Redirects are followed with desktop UA ([automation/batch/http.js](../automation/batch/http.js)).
- **Inline callbacks**: Capture (`capture_data`/`capture_decline`); batch confirm/cancel/abort (`batch_confirm_*`, `batch_cancel_*`, `batch_abort_*`); HOTMAIL selector (`batch_type_hotmail_*`). Replies should thread using `reply_to_message_id` when available.
- **Puppeteer specifics**: Launch args include `--no-sandbox`, `--disable-setuid-sandbox`, `--disable-dev-shm-usage`, `--disable-gpu`; random UA via `user-agents`; incognito context; viewport 1920x1080. Proxy via `--proxy-server=` when set. Navigation waits use `networkidle0`; password submit waits ~2s post-response.
- **Outcome detection**: [resultAnalyzer.js](../automation/resultAnalyzer.js) checks 200 + URL `code=` → VALID; 401 JSON → INVALID; captcha/challenge keywords → BLOCKED; invalid text → INVALID; URL `code=` fallback → VALID; else ERROR.
- **Markdown patterns**: Use `escapeV2` for user text; wrap filenames/URLs in `codeSpan` to avoid dot-related parse errors; batch progress/summary are MarkdownV2 edits—keep content escaped. Credentials in summaries use spoilers + monospace.
- **Error handling & cleanup**: `checkCredentials` closes browsers unless `deferCloseOnValid`; batch executor totals per-status and abort flag halts workers. Screenshots removed after use.
- **Commands/build**: `npm install`; `npm start` (no tests). Windows service options in [DEPLOYMENT.md](../DEPLOYMENT.md). Default shell PowerShell.

If anything is unclear (capture selectors, batch parsing edge cases, redirect handling), ask to expand that section.
